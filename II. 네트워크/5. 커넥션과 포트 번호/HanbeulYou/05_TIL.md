# 하루 3분 네트워크 교실

## 5. 커넥션과 포트 번호

### 1. 4계층의 역할과 개요

- 4계층의 역할
  - 하위 계층(1-3)의 역할 : 데이터 운반
    - 1계층 : 케이블이 연결되어 있는 상대에 대한 신호 전달
    - 2계층 : 신호를 주고받을 수 있는 상태일 때 세그먼트 내에서 어떻게 데이터 송수신 하는지
    - 3계층 : 세그먼트(네트워크) 사이에서 어떻게 데이터를 송수신하는지
  - 4계층 이상의 상위 계층에서는 전달할/전달될 데이터에 대한 필요한 처리
  - 4계층은 ‘신뢰성이 높은(에러가 적은) 데이터 전송을 하기’ 위한 처리
    - 3계층까지는 수신처가 존재하지 않거나 데이터가 도중에 손실됐거나 에러에 의해 파기됐다는 등의 문제 신경 X
  - 4계층이 에러 복구를 함
    - 도달하지 않은 경우(확인 응답이 돌아오지 않은 경우)에 다시 보냄으로써 에러를 없었던 것으로 함
  - 흐름 제어라는 방식으로 에러 복구 및 통신 상태 확인
    - 처리 능력을 넘어선 정보를 받았을 때 그것을 다 처리할 수 없어서 파기해버리는 경우가 있음
    - 이와 같은 ‘오버플로’를 방지
    - 수신측이 확인응답 때에 모아둘 수 있는 데이터양을 송신측에 통지
- 어플리케이션 식별
  - 실제로 데이터를 주고받는 것은 ‘어플리케이션’
  - 포트 번호(Port Number) : 어느 어플리케이션이 송신/수신한 데이터인지 결정하기 위해 부여
    - 데이터를 넣고 꺼내기 위한 가상의 출입구
    - 컴퓨터까지 도달한 데이터는 포트 번호를 근거로 그 데이터가 사용될 어플리케이션에 전달
- TCP와 UDP
  - 4계층의 ‘통신에 필요한 처리’를 위한 프로토콜
    - TCP(Transmission Control Protocol)
    - UDP(User Datagram Protocol)
    - 통신할 때 둘 중 한 쪽이 사용됨 → 서로 다른 역할

---

### 2. 커넥션과 세그먼트

- 커넥션
  - TCP에서 어플리케이션 간의 송수신을 하는 데이터의 길
  - 가상적인 통신로
    - 사전에 전용 통신로를 확보
    - 확실하게 데이터를 전송
    - 데이터 전송을 시작하기 전 미리 확인을 주고 받음
  - 가상의 통신로를 만들어내는 것을 커넥션 확립이라고 함
    - 통신로가 연결되어 있다 == 확실하게 통신할 수 있다
  - TCP헤더의 크기 : 20옥텟
    - TCP 헤더 6비트의 제어비트(플래그 : SYN, ACK 등)는 데이터의 의미를 나타냄
- 커넥션의 확립
  - 통신로를 확보하기 위해 상대에게 데이터 전송의 허가 요청을 보냄
    - 요청을 받은 상대는 그것에 대한 허가를 송신처에 알림
    - 통신로 확보
  - 이후 수신처 측이 송신처에게 데이터 전송 허가 요청을 보냄
    - 송신처도 데이터 전송 허가를 보냄
    - 쌍방향의 통로 확보
  - 마지막으로 송신처 측이 수신처 측에 커넥션 확립 응답
  - 해당 3가지 과정이 모두 이루어져야 커넥션 확립 → 쓰리웨이 핸드쉐이크(3way Handshake)
- 세그먼트 분할
  - TCP는 어플리케이션으로부터 받은 데이터(메시지)를 세그먼트로 캡슐화함
    - 캡슐화할 때 한 개의 데이터를 MSS(Max Segment Size)로 분할
    - 한 개의 데이터가 복수의 세그먼트가 됨
    - 각각의 세그먼트에 번호를 부여(시퀀스 번호)
  - 시퀀스 번호
    - 세그먼트에 포함되어 있는 데이터의 선두 옥텟에 붙여진 번호

---

### 3. 윈도우 제어

- 에러 복구
  - 시퀀스 번호를 사용해 에러를 복구
  - 확인응답 : 세그먼트를 수신하면 수신한 것을 송신처에게 전달
  - 데이터 통신 시에는 ‘시퀀스 번호’가, 확인응답에는 ‘확인응답 번호’가 중요한 값이 됨
  - 시퀀스 번호
    - 보내는 데이터 앞 부분에 있는 옥텟 번호
  - 확인응답 번호
    - 다음에 받고 싶은 데이터의 선두 옥텟 번호
    - 수신했어요 대신 다음에 받을 예정의 데이터 번호 전달
    - 수신측이 어느 데이터까지 받았는지 알 수 있음
  - 에러가 발생해 데이터가 상대방에게 도달하지 않았거나 확인응답이 도달하지 않으면 데이터 재전송
  - RTT(Round Trip Time)
    - 지금까지 보낸 데이터에 대한 확인응답이 돌아오기까지 걸린 시간
    - 초기값을 약 3초로 정해두고 동적으로 변경(회선의 속도 등 고려)
- 윈도우 제어
  - 시간 효율을 위해 ‘복수의 세그먼트전송 → 확인응답’ 형태를 가짐
  - 정확+확실하게 보내기 위해 TCP는 흐름제어의 하나인 윈도우 제어를 함
  - 버퍼(Buffer) - 데이터를 일시적으로 보관
  - 윈도우 사이즈 : 어느정도 버퍼량을 가지고 있는지
    - 확인응답을 기다리지 않고 보낼 수 있는 데이터양
    - 확실하게 수신할 수 있는 용량

---

### 4. 포트번호

- 어플리케이션 간 통신
  - 포트번호를 사용해 각각의 데이터가 어느 어플리케이션으로부터 송신 되었는지, 어느 어플리에키션 수신인지 결정
  - 각 컴퓨터 내부의 통신 데이터를 흐르게 하기 위한 가상의 출입구
    - 각 어플리케이션은 그 중의 하나를 선택해 데이터 송수신의 입구로 삼음
    - 포트는 16비트(65,536개)가 있음
    - 포트에 붙여진 포트 번호로 데이터를 보낼 어플리케이션을 특정
  - IP 주소와 포트번호를 활용해 ‘어느 컴퓨터의 어느 어플리케이션’인지 식별
  - 수신처 포트 번호를 모르면 데이터를 보낼 수 없음
  - 수신 받을 어플리케이션이 포트와 접속해 있지 않으면 데이터 도달 X
  - 자주 사용하는 서버 어플리케이션(Server Application)은 사전에 정해진 번호를 사용 → 서비스 제공
    - 서버 어플리케이션 : 서비스를 제공하는 어플리케이션
    - 웰 노운 포트(Well Known Port) : 1~1023번
    - 현재 어플리케이션이 사용하고 있는 번호를 전달할 방법이 없음 → 왠만하면 웰 노운 포트 번호 사용

---

### 5. UDP

- TCP의 단점
  - 쓰리웨이 핸드쉐이크 → 확인 응답을 기다리는 시간이 필요
    - 무엇을 하더라도 일정시간 기다려야함
  - 전송 효율의 저하를 일으키는 원인이 될 수 있음
- 아무것도 하지 않는 UDP
  - UDP의 헤더
    - 포트 번호 이외에 아무것도 없음
    - 시퀀스 번호 X, 확인 응답 번호 X, 윈도우 사이즈 X, 제어비트 X
  - UDP는 고속
- UDP의 용도
  - 고속성이나 실시간 송수신이 필요한 어플리케이션
    - VoIP(Voice over IP)
    - 동영상 스트리밍 배포
  - 브로드캐스트가 필요한 어플리케이션
    - TCP로 전체에게 통신하려면 전체와 커넥션을 확립해야함
    - 특히 상대가 있는지 없는지 모르는 DHCP 등은 커넥션을 취할 방법이 없음

---

### 6. 네트워크 주소 변환

- 사설 IP 주소
  - 글로벌 IP 주소
    - ICANN이 관리하는 IP 주소
    - IP를 유일하게 관리
  - 사설 IP 주소
    - 인터넷에 연결하지 않으면 자유롭게 주소 사용
  - IP 주소의 고갈 문제를 해결하기 위한 방안
    - 네트워크 주소 변환(Network Address Translation)
- 네트워크 주소 변환
  - NAT라고 부름
  - 내부 네트워크에는 사설 IP 주소를 할당
    - 내부 네트워크 내에서 TCP/IP를 사용한 통신
    - 사설 IP 주소를 글로벌 IP 주소로 변환
  - 단점
    - 동시 접속 수의 문제
    - 글로벌 IP 주소의 수만큼만 동시에 접속할 수 있음
    - NAT에서 변환되는 주소는 유일해야함
  - NAT를 발전시킨 NAPT

---

### 7. NAPT

- NAPT(Network Address Port Translation)
  - 하나의 글로벌 IP 주소로 복수의 컴퓨터를 접속 가능하게 함
  - IP 주소뿐만 아니라 포트 번호도 변환
  - 포트 번호 정보를 추가함으로써 한 개의 글로벌 IP 주소로 접속하고 있는 복수의 기기를 구별할 수 있음
  - 보안의 장점이 있음
    - 수신처가 변환되어 있지 않은 포트 번호 수신이기 때문에 사설 IP 주소로 변환 X
    - 내부 네트워크에 데이터가 흘러가지 않음
- 정적 NAPT
  - 보안이 NAPT의 단점이 될 수 있음
    - LAN 내부에서 외부로 공개하고 싶은 서버가 있을 경우
    - NAPT 테이블에 저장되어 있지 않은 것은 LAN 내부에 들어오지 못함
    - NAPT 테이블에 미리 변환을 저장시켜 해결(수동)
    - 이런 NAPT를 정적 NAPT라고 함
- NAPT의 단점
  - FTP(File Transfer Protocol)
    - 웹페이지에서 사용하는 프로토콜
    - 파일을 업로드하거나 다운로드할 때 사용
    - IP헤더에 수신처와 송신처의 IP 주소, TCP 헤더에 수신처와 송신처의 포트 번호가 사용
    - 데이터 부분에도 송신처의 IP 주소와 포트 번호가 기술
    - 인터넷에서 사설 IP 주소 수신으로 데이터를 보낼 수 없음
  - 데이터 부분에도 송신처의 IP 주소와 포트 번호가 기술되는 것은 안 됨

---

### 8. 5~7 계층

- 5계층 : 세션계층
  - 5~7층은 TCP/IP 모델에서는 어플리케이션 1개층으로 취급 됨
    - 통합해서 하나의 프로토콜이 된 경우가 많음
  - 세션 : 어플리케이션 간의 의논
  - 다이얼로그 제어(Dialog Control) : 이러한 의논이 성립하도록 제어
- 6계층 : 표현계층
  - TCP/IP에는 다양한 어플리케이션이 존재하고, 각각의 목적에 맞는 데이터 형식이 있음
  - 어플피케이션간 데이터 형식의 차이가 있을 수 있음
  - 6계층에서 변환을 해서 하드웨어랑 OS에 따른 차이를 없앤 데이터 교환이 가능
  - 압축이나 암호화 수행 가능
- 7계층 : 응용계층
  - 어플리케이션을 위해 움직이는 계층
    - 목적에 따라 네트워크 서비스를 제공하는 계층
    - 각각의 목적에 따른 프로토콜이 준비되어 있음